version: '3.5'
services:

  view-xcolab:
    image: mikirockerful/view-xcolab
    networks:
      - xcolab-network
    volumes:
      - '~/.xcolab.application.properties:/root/.xcolab.application.properties'
      - '${FILES_UPLOAD_DIR?"Specify a path for user uploaded files in env variable FILES_UPLOAD_DIR"}:/var/xcolab-images/'
    restart: on-failure
    depends_on:
      - xcolab_mysql
      - activities-service-xcolab
      - admin-service-xcolab
      - comment-service-xcolab
      - content-service-xcolab
      - contest-service-xcolab
      - emails-service-xcolab
      - members-service-xcolab
      - modeling-service-xcolab
      - moderation-service-xcolab
      - search-service-xcolab
      - tracking-service-xcolab
    deploy:
      placement:
        constraints: [node.role == manager]

  eureka-server-xcolab:
    image: mikirockerful/eureka-server-xcolab
    networks:
      xcolab-network:
        aliases:
          - eureka-server


  activities-service-xcolab:
    image: mikirockerful/activities-service-xcolab
    networks:
      - xcolab-network
    volumes:
      - '~/.xcolab.application.properties:/root/.xcolab.application.properties'
    restart: on-failure
    depends_on:
      - xcolab_mysql
      - eureka-server-xcolab
  admin-service-xcolab:
    image: mikirockerful/admin-service-xcolab
    networks:
      - xcolab-network
    volumes:
      - '~/.xcolab.application.properties:/root/.xcolab.application.properties'
    restart: on-failure
    depends_on:
      - xcolab_mysql
      - eureka-server-xcolab
  comment-service-xcolab:
    image: mikirockerful/comment-service-xcolab
    networks:
      - xcolab-network
    volumes:
      - '~/.xcolab.application.properties:/root/.xcolab.application.properties'
    restart: on-failure
    depends_on:
      - xcolab_mysql
      - eureka-server-xcolab
  content-service-xcolab:
    image: mikirockerful/content-service-xcolab
    networks:
      - xcolab-network
    volumes:
      - '~/.xcolab.application.properties:/root/.xcolab.application.properties'
    restart: on-failure
    depends_on:
      - xcolab_mysql
      - eureka-server-xcolab
  contest-service-xcolab:
    image: mikirockerful/contest-service-xcolab
    networks:
      - xcolab-network
    volumes:
      - '~/.xcolab.application.properties:/root/.xcolab.application.properties'
    restart: on-failure
    depends_on:
      - xcolab_mysql
      - eureka-server-xcolab
  emails-service-xcolab:
    image: mikirockerful/emails-service-xcolab
    networks:
      - xcolab-network
    volumes:
      - '~/.xcolab.application.properties:/root/.xcolab.application.properties'
    restart: on-failure
    depends_on:
      - xcolab_mysql
      - eureka-server-xcolab
  members-service-xcolab:
    image: mikirockerful/members-service-xcolab
    networks:
      - xcolab-network
    volumes:
      - '~/.xcolab.application.properties:/root/.xcolab.application.properties'
    restart: on-failure
    depends_on:
      - xcolab_mysql
      - eureka-server-xcolab
  modeling-service-xcolab:
    image: mikirockerful/modeling-service-xcolab
    networks:
      - xcolab-network
    volumes:
      - '~/.xcolab.application.properties:/root/.xcolab.application.properties'
    restart: on-failure
    depends_on:
      - xcolab_mysql
      - eureka-server-xcolab
  moderation-service-xcolab:
    image: mikirockerful/moderation-service-xcolab
    networks:
      - xcolab-network
    volumes:
      - '~/.xcolab.application.properties:/root/.xcolab.application.properties'
    restart: on-failure
    depends_on:
      - xcolab_mysql
      - eureka-server-xcolab
  search-service-xcolab:
    image: mikirockerful/search-service-xcolab
    networks:
      - xcolab-network
    volumes:
      - '~/.xcolab.application.properties:/root/.xcolab.application.properties'
    restart: on-failure
    depends_on:
      - xcolab_mysql
      - eureka-server-xcolab
  tracking-service-xcolab:
    image: mikirockerful/tracking-service-xcolab
    networks:
      - xcolab-network
    volumes:
      - '~/.xcolab.application.properties:/root/.xcolab.application.properties'
    restart: on-failure
    depends_on:
      - xcolab_mysql
      - eureka-server-xcolab

  xcolab_mysql:
    image: mysql/mysql-server:5.7
    environment:
      - MYSQL_DATABASE=xcolab
      - MYSQL_USER=xcolab
      - MYSQL_PASSWORD=${MYSQL_PASSWORD?"Specify DB password for xcolab user in env MYSQL_PASSWORD"}
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD?"Specify DB password for root in env MYSQL_ROOT_PASSWORD"}
      - MYSQL_ROOT_HOST=127.0.0.1
    networks:
      - xcolab-network
    volumes:
      - './mysql/mysql_config:/etc/mysql'
      - '${DATABASE_PATH?"Specify DATABASE_PATH"}:/var/lib/mysql'
    deploy:
      placement:
        constraints: [node.role == manager]

  database-starter-xcolab:
    image: mikirockerful/mysql_client
    environment:
      - MYSQL_PASSWORD=${MYSQL_PASSWORD?"Specify DB password for xcolab user in env MYSQL_PASSWORD"}
    volumes:
      - '../sql/starter/xcolab-data.sql:/xcolab-data.sql'
    command: sh -c "sleep 300 && mysql -h xcolab_mysql -u xcolab --password=$MYSQL_PASSWORD xcolab < /xcolab-data.sql"
    networks:
      - xcolab-network
    depends_on:
      - xcolab_mysql
      - activities-service-xcolab
      - admin-service-xcolab
      - comment-service-xcolab
      - content-service-xcolab
      - contest-service-xcolab
      - emails-service-xcolab
      - members-service-xcolab
      - modeling-service-xcolab
      - moderation-service-xcolab
      - search-service-xcolab
      - tracking-service-xcolab
    restart_policy:
      condition: none

  apache-xcolab:
    build: ./apache
    ports:
      - "80:80"
      - "443:443"
    networks:
      - xcolab-network
    depends_on:
      - view-xcolab
    deploy:
      placement:
        constraints: [node.role == manager]

networks:
  xcolab-network:
    name: xcolab-network
